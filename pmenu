#!/usr/bin/env python
import os
import sys
import re
import signal
import difflib
import curses

prompt_text = "> "
query_text = ''
input_items = sys.stdin.read().splitlines()
filtered_items = None
selection_index = 0

def signal_handler(signum, frame):
    sys.exit(130)
signal.signal(signal.SIGINT, signal_handler)

def filter_items():
    global filtered_items

    filtered_items = []
    query_text_regex = re.compile(r".*".join(re.escape(query_text_char) for query_text_char in query_text), flags=re.IGNORECASE)
    for input_item in input_items:
        if query_text and not query_text_regex.search(input_item):
            continue

        if query_text:
            item_score = difflib.SequenceMatcher(None, input_item, query_text).quick_ratio()
        else:
            item_score = 1
        filtered_items.append((input_item, item_score))

    if query_text:
        filtered_items = sorted(filtered_items, key=lambda filtered_item: filtered_item[1], reverse=True)

def redraw(window):
    window.erase()

    window.addstr(prompt_text)

    for i, filtered_item in enumerate(filtered_items[:curses.LINES - 1]):
        item_attr = curses.A_REVERSE if i == selection_index else curses.A_NORMAL
        window.insstr(i + 1, 0, filtered_item[0][:curses.COLS], item_attr)

    query_text_offset = len(query_text) - (curses.COLS - len(prompt_text) - 1)
    if query_text_offset < 0:
        query_text_offset = 0
    window.addstr(0, len(prompt_text), query_text[query_text_offset:])

    window.refresh()

def change_selection(new_selection_index):
    global selection_index

    if new_selection_index < 0 or new_selection_index >= min(len(filtered_items), curses.LINES - 1):
        return

    selection_index = new_selection_index

def main(window):
    global query_text, selection_index

    terminal_file = open("/dev/tty")
    os.dup2(terminal_file.fileno(), 0)

    filter_items()
    redraw(window)

    while True:
        char = window.get_wch()
        if isinstance(char, str):
            keyname = curses.keyname(ord(char)).decode('utf8')
        if char == curses.KEY_RESIZE:
            y, x = window.getmaxyx()
            curses.resizeterm(y, x)
            selection_index = 0
            redraw(window)
            continue
        elif not isinstance(char, str):
            continue
        elif char == '\n':
            return
        elif char == '\b':
            query_text = query_text[:-1]
        elif keyname == '^G':
            sys.exit(130)
        elif keyname == '^U':
            query_text = ''
        elif keyname == '^W':
            query_text = re.sub(r"\w*[^\w]*$", '', query_text)
        elif keyname == '^N':
            change_selection(selection_index + 1)
            redraw(window)
            continue
        elif keyname == '^P':
            change_selection(selection_index - 1)
            redraw(window)
            continue
        elif len(keyname) == 2 and keyname[0] == '^':
            continue
        else:
            query_text += char

        selection_index = 0
        filter_items()
        redraw(window)

curses.wrapper(main)

print(filtered_items[selection_index][0])
